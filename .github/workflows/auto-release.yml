name: Auto Release

on:
  push:
    branches: [main, master]
    paths: ['package.json']

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  check-version:
    name: Check Version Change
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.check.outputs.changed }}
      new-version: ${{ steps.check.outputs.version }}
      should-release: ${{ steps.check.outputs.should-release }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Check version change
      id: check
      run: |
        # èŽ·å–å½“å‰ç‰ˆæœ¬
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        # èŽ·å–ä¸Šä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬
        git checkout HEAD~1 -- package.json 2>/dev/null || echo "No previous version"
        PREVIOUS_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "0.0.0")
        echo "Previous version: $PREVIOUS_VERSION"
        
        # æ¢å¤å½“å‰ç‰ˆæœ¬
        git checkout HEAD -- package.json
        
        # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å˜åŒ–
        if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
          echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "should-release=true" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "v$CURRENT_VERSION" >/dev/null 2>&1; then
            echo "Tag v$CURRENT_VERSION already exists, skipping release"
            echo "should-release=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "Version unchanged"
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "should-release=false" >> $GITHUB_OUTPUT
        fi

  build-and-release:
    name: Build and Release
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: kkape-gearbox
          
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: kkape-gearbox.exe
          
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: kkape-gearbox
          
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: kkape-gearbox
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: System Information
      run: |
        echo "ðŸ–¥ï¸ System Information for ${{ matrix.os }} (${{ matrix.target }})"
        echo "=================================="
        echo "OS: $(uname -a)"
        echo "Architecture: $(uname -m)"
        echo "CPU Info:"
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          lscpu | head -20
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          sysctl -n machdep.cpu.brand_string
          sysctl -n hw.ncpu
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          wmic cpu get name
        fi
        echo "Memory:"
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          free -h
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}'
        fi
        echo "Disk Space:"
        df -h
        echo "=================================="
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install pnpm
      run: |
        echo "ðŸ”§ Installing pnpm..."
        npm install -g pnpm
        echo "âœ… pnpm version: $(pnpm --version)"
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Verify Rust installation
      run: |
        echo "ðŸ¦€ Rust toolchain information:"
        rustc --version
        cargo --version
        echo "ðŸŽ¯ Target: ${{ matrix.target }}"
        rustup target list --installed | grep ${{ matrix.target }} || echo "âŒ Target ${{ matrix.target }} not installed"
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "ðŸ§ Installing Ubuntu system dependencies..."
        echo "ðŸ“¦ Updating package list..."
        sudo apt-get update -y
        echo "ðŸ“¦ Installing required packages..."
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.0-dev \
          libappindicator3-dev \
          librsvg2-dev \
          patchelf \
          build-essential \
          curl \
          wget \
          file \
          libssl-dev \
          libayatana-appindicator3-dev
        echo "âœ… Ubuntu dependencies installed successfully"

        # éªŒè¯å…³é”®åº“æ˜¯å¦å®‰è£…
        echo "ðŸ” Verifying installed packages..."
        pkg-config --exists gtk+-3.0 && echo "âœ… GTK3 found" || echo "âŒ GTK3 missing"
        pkg-config --exists webkit2gtk-4.0 && echo "âœ… WebKit2GTK found" || echo "âŒ WebKit2GTK missing"
    
    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing Node.js dependencies..."
        pnpm install --frozen-lockfile
        echo "âœ… Dependencies installed successfully"
        echo "ðŸ“‹ Workspace info:"
        pnpm list --depth=0
    
    - name: Generate icons
      run: |
        echo "ðŸŽ¨ Generating application icons..."
        pnpm generate:icons
        echo "âœ… Icons generated successfully"

        # éªŒè¯å›¾æ ‡æ–‡ä»¶
        echo "ðŸ” Verifying generated icons..."
        if [ -d "apps/shell/src-tauri/icons" ]; then
          ls -la apps/shell/src-tauri/icons/
          echo "âœ… Icon directory exists"
        else
          echo "âŒ Icon directory missing"
        fi
    
    - name: Build frontend
      run: |
        echo "ðŸ—ï¸ Building frontend application..."
        echo "ðŸ“‚ Current directory: $(pwd)"
        echo "ðŸ“‹ Available workspaces:"
        pnpm list --depth=0

        echo "ðŸ” Checking Node.js and pnpm versions:"
        node --version
        pnpm --version

        echo "ðŸ” Checking shell package:"
        if [ -d "ui/shell" ]; then
          echo "âœ… ui/shell directory exists"
          ls -la ui/shell/

          echo "ðŸ” Checking package.json:"
          if [ -f "ui/shell/package.json" ]; then
            echo "âœ… package.json exists"
            cat ui/shell/package.json | jq '.name, .version, .scripts.build' 2>/dev/null || echo "Cannot parse package.json"
          fi

          echo "ðŸ” Checking dependencies:"
          cd ui/shell
          pnpm list --depth=0 2>/dev/null || echo "Cannot list dependencies"
          cd ..
        else
          echo "âŒ ui/shell directory missing"
        fi

        echo "ðŸ”¨ Building shell UI..."
        set -e  # Exit on any error
        pnpm --filter shell build

        echo "âœ… Frontend build completed"
        echo "ðŸ” Verifying build output..."
        if [ -d "ui/shell/dist" ]; then
          echo "âœ… Frontend dist directory exists"
          ls -la ui/shell/dist/
          echo "ðŸ“Š Build size:"
          du -sh ui/shell/dist/
        else
          echo "âŒ Frontend dist directory missing"
          echo "ðŸ“‚ Checking alternative locations..."
          find . -name "dist" -type d 2>/dev/null || echo "No dist directories found"
          exit 1
        fi
    
    - name: Build Tauri app
      run: |
        echo "ðŸ¦€ Building Tauri application for ${{ matrix.target }}..."
        echo "ðŸ“‚ Current directory: $(pwd)"

        cd apps/shell
        echo "ðŸ“‚ Changed to: $(pwd)"

        # æ˜¾ç¤º Tauri é…ç½®ä¿¡æ¯
        echo "ðŸ” Tauri configuration:"
        if [ -f "tauri.conf.json" ]; then
          echo "âœ… tauri.conf.json exists"
          cat tauri.conf.json | jq '.version // "version not found"' 2>/dev/null || echo "Cannot parse version from tauri.conf.json"
        else
          echo "âŒ tauri.conf.json missing"
        fi

        # æ˜¾ç¤º Cargo ä¿¡æ¯
        echo "ðŸ” Cargo configuration:"
        if [ -f "Cargo.toml" ]; then
          echo "âœ… Cargo.toml exists"
          grep "^version" Cargo.toml || echo "Version not found in Cargo.toml"
        else
          echo "âŒ Cargo.toml missing"
        fi

        # æ£€æŸ¥ Rust æºç ç›®å½•
        if [ -d "src" ]; then
          echo "âœ… src directory exists"
          ls -la src/
        else
          echo "âŒ src directory missing"
        fi

        echo "ðŸ”¨ Starting Tauri build..."
        echo "ðŸŽ¯ Target: ${{ matrix.target }}"
        echo "ðŸ–¥ï¸ OS: ${{ matrix.os }}"

        # è®¾ç½®è¯¦ç»†æ—¥å¿—
        export RUST_LOG=debug
        export RUST_BACKTRACE=1

        # æ‰§è¡Œæž„å»º
        set -e  # Exit on any error
        cargo tauri build --target ${{ matrix.target }} --verbose

        echo "âœ… Tauri build completed"

        # éªŒè¯æž„å»ºäº§ç‰©
        echo "ðŸ” Verifying build artifacts..."
        if [ -d "target/${{ matrix.target }}/release" ]; then
          echo "âœ… Release directory exists"
          ls -la "target/${{ matrix.target }}/release/"

          # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶
          echo "ðŸ” Looking for executable..."
          find "target/${{ matrix.target }}/release" -name "${{ matrix.artifact_name }}" -type f 2>/dev/null || echo "âŒ Executable not found"

          # æŸ¥æ‰¾ bundle ç›®å½•
          if [ -d "target/${{ matrix.target }}/release/bundle" ]; then
            echo "âœ… Bundle directory exists"
            find "target/${{ matrix.target }}/release/bundle" -type f 2>/dev/null | head -10
          else
            echo "âŒ Bundle directory missing"
          fi
        else
          echo "âŒ Release directory missing"
          echo "ðŸ“‚ Available directories in target:"
          ls -la "target/" 2>/dev/null || echo "Target directory not found"
        fi

    - name: Debug on failure
      if: failure()
      run: |
        echo "ðŸš¨ Build failed! Collecting debug information..."
        echo "=================================="

        # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
        echo "ðŸ“‹ Recent Cargo build logs:"
        if [ -f "apps/shell/target/${{ matrix.target }}/release/build.log" ]; then
          tail -50 "apps/shell/target/${{ matrix.target }}/release/build.log"
        fi

        # æŸ¥æ‰¾æž„å»ºæ—¥å¿—
        echo "ðŸ” Looking for build logs..."
        find apps/shell/target -name "*.log" -type f 2>/dev/null | head -5 | while read logfile; do
          echo "ðŸ“„ Log file: $logfile"
          tail -20 "$logfile"
        done

        # æ˜¾ç¤º Cargo ç¼“å­˜çŠ¶æ€
        echo "ðŸ“¦ Cargo cache status:"
        ls -la ~/.cargo/ 2>/dev/null || echo "Cargo cache not found"

        # æ˜¾ç¤ºç›®æ ‡æž¶æž„ä¿¡æ¯
        echo "ðŸŽ¯ Target architecture info:"
        rustup target list --installed

        # æ˜¾ç¤ºçŽ¯å¢ƒå˜é‡
        echo "ðŸŒ Environment variables:"
        env | grep -E "(RUST|CARGO|TARGET)" | sort

        # æ˜¾ç¤ºæ–‡ä»¶ç³»ç»ŸçŠ¶æ€
        echo "ðŸ“‚ File system status:"
        pwd
        ls -la

        if [ -d "apps/shell" ]; then
          echo "ðŸ“‚ apps/shell contents:"
          ls -la apps/shell/

          if [ -d "apps/shell/src" ]; then
            echo "ðŸ“‚ src contents:"
            ls -la apps/shell/src/
          fi

          if [ -d "apps/shell/target" ]; then
            echo "ðŸ“‚ target contents:"
            ls -la apps/shell/target/
          fi
        fi

        # macOS ç‰¹å®šè°ƒè¯•
        if [ "${{ matrix.os }}" = "macos-latest" ]; then
          echo "ðŸŽ macOS specific debug info:"
          xcode-select --print-path
          xcrun --show-sdk-path
          echo "Available SDKs:"
          xcodebuild -showsdks 2>/dev/null || echo "Cannot show SDKs"
        fi

        # Ubuntu ç‰¹å®šè°ƒè¯•
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          echo "ðŸ§ Ubuntu specific debug info:"
          echo "Installed packages:"
          dpkg -l | grep -E "(gtk|webkit|appindicator)" || echo "No relevant packages found"
          echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
          pkg-config --list-all | grep -E "(gtk|webkit)" || echo "No relevant pkg-config files"
        fi

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.os }}-${{ matrix.target }}
        path: |
          apps/shell/target/${{ matrix.target }}/release/build/
          ~/.cargo/registry/cache/
          apps/shell/Cargo.lock
          apps/shell/target/${{ matrix.target }}/release/deps/
        retention-days: 7
    
    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ needs.check-version.outputs.new-version }}"
        if [ -f CHANGELOG.md ]; then
          CHANGELOG=$(awk "/## \[$VERSION\]/{flag=1; next} /## \[/{flag=0} flag" CHANGELOG.md || echo "Release version $VERSION")
        else
          CHANGELOG="Release version $VERSION"
        fi
        echo "$CHANGELOG" > changelog.txt
    
    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.check-version.outputs.new-version }}
        name: KKAPE Gearbox v${{ needs.check-version.outputs.new-version }}
        body_path: changelog.txt
        draft: false
        prerelease: ${{ contains(needs.check-version.outputs.new-version, 'beta') || contains(needs.check-version.outputs.new-version, 'alpha') || contains(needs.check-version.outputs.new-version, 'rc') }}
        make_latest: true
        generate_release_notes: true
        files: |
          apps/shell/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          apps/shell/target/${{ matrix.target }}/release/bundle/**/*
